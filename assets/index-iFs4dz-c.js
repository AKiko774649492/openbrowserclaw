(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();const A="Andy";function I(a){const t=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`(^|\\s)@${t}\\b`,"i")}I(A);const _=50,O=8096,P="claude-sonnet-4-6",R="https://api.telegram.org/bot",Z=4096,tt=30,et=6e4,st="openbrowserclaw",nt=1,it="openbrowserclaw",f="br:main",p={ANTHROPIC_API_KEY:"anthropic_api_key",TELEGRAM_BOT_TOKEN:"telegram_bot_token",TELEGRAM_CHAT_IDS:"telegram_chat_ids",MODEL:"model",MAX_TOKENS:"max_tokens",ASSISTANT_NAME:"assistant_name"};let C=null;function at(){return new Promise((a,t)=>{const e=indexedDB.open(st,nt);e.onupgradeneeded=()=>{const s=e.result;if(!s.objectStoreNames.contains("messages")){const n=s.createObjectStore("messages",{keyPath:"id"});n.createIndex("by-group-time",["groupId","timestamp"]),n.createIndex("by-group","groupId")}if(s.objectStoreNames.contains("sessions")||s.createObjectStore("sessions",{keyPath:"groupId"}),!s.objectStoreNames.contains("tasks")){const n=s.createObjectStore("tasks",{keyPath:"id"});n.createIndex("by-group","groupId"),n.createIndex("by-enabled","enabled")}s.objectStoreNames.contains("config")||s.createObjectStore("config",{keyPath:"key"})},e.onsuccess=()=>{C=e.result,a(C)},e.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${e.error?.message}`))}})}function k(){if(!C)throw new Error("Database not initialized. Call openDatabase() first.");return C}function y(a,t,e){return new Promise((s,n)=>{const o=k().transaction(a,t).objectStore(a),r=e(o);r.onsuccess=()=>s(r.result),r.onerror=()=>n(r.error)})}function S(a){return y("messages","readwrite",t=>t.put(a)).then(()=>{})}function Y(a,t){return new Promise((e,s)=>{const o=k().transaction("messages","readonly").objectStore("messages").index("by-group-time"),r=IDBKeyRange.bound([a,0],[a,1/0]),c=o.openCursor(r,"prev"),h=[];c.onsuccess=()=>{const d=c.result;d&&h.length<t?(h.push(d.value),d.continue()):e(h.reverse())},c.onerror=()=>s(c.error)})}function $(a){return y("tasks","readwrite",t=>t.put(a)).then(()=>{})}function ot(a){return y("tasks","readwrite",t=>t.delete(a)).then(()=>{})}function rt(){return new Promise((a,t)=>{const i=k().transaction("tasks","readonly").objectStore("tasks").index("by-enabled").getAll(1);i.onsuccess=()=>a(i.result),i.onerror=()=>t(i.error)})}function ct(){return y("tasks","readonly",a=>a.getAll())}function lt(a,t){return new Promise((e,s)=>{const i=k().transaction("tasks","readwrite").objectStore("tasks"),o=i.get(a);o.onsuccess=()=>{const r=o.result;if(!r){e();return}r.lastRun=t;const c=i.put(r);c.onsuccess=()=>e(),c.onerror=()=>s(c.error)},o.onerror=()=>s(o.error)})}function u(a){return y("config","readonly",t=>t.get(a)).then(t=>t?.value)}function g(a,t){return y("config","readwrite",e=>e.put({key:a,value:t})).then(()=>{})}function U(a){return new Promise((t,e)=>{const o=k().transaction("messages","readwrite").objectStore("messages").index("by-group").openCursor(a);o.onsuccess=()=>{const r=o.result;r?(r.delete(),r.continue()):t()},o.onerror=()=>e(o.error)})}async function H(a,t){return(await Y(a,t)).map(s=>({role:s.isFromMe?"assistant":"user",content:s.isFromMe?s.content:`${s.sender}: ${s.content}`}))}async function ht(a,...t){let e=a;for(const s of t)e=await e.getDirectoryHandle(s,{create:!0});return e}async function dt(a){const t=await navigator.storage.getDirectory(),e=a.replace(/:/g,"-");return ht(t,it,"groups",e)}function pt(a){const e=a.replace(/\\/g,"/").replace(/^\/+/,"").split("/").filter(Boolean);if(e.length===0)throw new Error("Empty file path");const s=e.pop();return{dirs:e,filename:s}}async function F(a,t){const e=await dt(a),{dirs:s,filename:n}=pt(t);let i=e;for(const c of s)i=await i.getDirectoryHandle(c);return(await(await i.getFileHandle(n)).getFile()).text()}async function ut(){return navigator.storage&&navigator.storage.persist?navigator.storage.persist():!1}async function gt(){if(navigator.storage&&navigator.storage.estimate){const a=await navigator.storage.estimate();return{usage:a.usage||0,quota:a.quota||0}}return{usage:0,quota:0}}const mt="obc-keystore",v="keys",G="api-key-encryption",N=12;function ft(){return new Promise((a,t)=>{const e=indexedDB.open(mt,1);e.onupgradeneeded=()=>{e.result.createObjectStore(v)},e.onsuccess=()=>a(e.result),e.onerror=()=>t(e.error)})}async function Q(){const a=await ft(),t=await new Promise((s,n)=>{const o=a.transaction(v,"readonly").objectStore(v).get(G);o.onsuccess=()=>s(o.result),o.onerror=()=>n(o.error)});if(t)return a.close(),t;const e=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return await new Promise((s,n)=>{const i=a.transaction(v,"readwrite");i.objectStore(v).put(e,G),i.oncomplete=()=>s(),i.onerror=()=>n(i.error)}),a.close(),e}async function yt(a){const t=await Q(),e=crypto.getRandomValues(new Uint8Array(N)),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,new TextEncoder().encode(a)),n=new Uint8Array(e.length+new Uint8Array(s).length);return n.set(e),n.set(new Uint8Array(s),e.length),btoa(String.fromCharCode(...n))}async function z(a){const t=await Q(),e=Uint8Array.from(atob(a),o=>o.charCodeAt(0)),s=e.slice(0,N),n=e.slice(N),i=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},t,n);return new TextDecoder().decode(i)}const B="0123456789ABCDEFGHJKMNPQRSTVWXYZ",b=B.length,K=10,Et=16;let j=0,m=[];function T(){const a=Date.now();if(a===j)for(let n=m.length-1;n>=0;n--){if(m[n]<b-1){m[n]++;break}m[n]=0}else j=a,m=Array.from(crypto.getRandomValues(new Uint8Array(Et)),n=>n%b);let t=a;const e=new Array(K);for(let n=K-1;n>=0;n--)e[n]=B[t%b],t=Math.floor(t/b);const s=m.map(n=>B[n]);return e.join("")+s.join("")}class vt{type="browser";messageCallback=null;typingCallback=null;displayCallback=null;activeGroupId=f;start(){}stop(){}submit(t,e){const s=e||this.activeGroupId,n={id:T(),groupId:s,sender:"You",content:t,timestamp:Date.now(),channel:"browser"};this.messageCallback?.(n)}async send(t,e){this.displayCallback?.(t,e,!0)}setTyping(t,e){this.typingCallback?.(t,e)}onMessage(t){this.messageCallback=t}onTyping(t){this.typingCallback=t}onDisplay(t){this.displayCallback=t}setActiveGroup(t){this.activeGroupId=t}getActiveGroup(){return this.activeGroupId}}class wt{type="telegram";token="";registeredChatIds=new Set;offset=0;abortController=null;messageCallback=null;running=!1;configure(t,e){this.token=t,this.registeredChatIds=new Set(e)}registerChatId(t){this.registeredChatIds.add(t)}start(){this.token&&(this.running||(this.running=!0,this.abortController=new AbortController,this.poll()))}stop(){this.running=!1,this.abortController?.abort(),this.abortController=null}async send(t,e){const s=t.replace(/^tg:/,""),n=kt(e,Z);for(const i of n)await this.apiCall("sendMessage",{chat_id:s,text:i,parse_mode:"Markdown"})}setTyping(t,e){if(!e)return;const s=t.replace(/^tg:/,"");this.apiCall("sendChatAction",{chat_id:s,action:"typing"}).catch(()=>{})}onMessage(t){this.messageCallback=t}isConfigured(){return this.token.length>0}async poll(){for(;this.running&&this.abortController&&!this.abortController.signal.aborted;)try{const t=await fetch(`${R}${this.token}/getUpdates?offset=${this.offset}&timeout=${tt}`,{signal:this.abortController.signal});if(!t.ok){console.error(`Telegram poll error: HTTP ${t.status}`),await L(5e3);continue}const e=await t.json();if(!e.ok||!e.result){await L(5e3);continue}for(const s of e.result)this.offset=s.update_id+1,this.handleUpdate(s)}catch(t){if(t instanceof Error&&t.name==="AbortError")break;console.error("Telegram poll error:",t),await L(5e3)}}handleUpdate(t){const e=t.message;if(!e)return;const s=String(e.chat.id);if(e.text==="/chatid"){this.apiCall("sendMessage",{chat_id:s,text:`Chat ID: \`${s}\`
Register this ID in OpenBrowserClaw settings.`,parse_mode:"Markdown"}).catch(console.error);return}if(e.text==="/ping"){this.apiCall("sendMessage",{chat_id:s,text:"Pong! üèì OpenBrowserClaw is running."}).catch(console.error);return}if(!this.registeredChatIds.has(s))return;const n=e.text||(e.photo?"[Photo]":null)||(e.voice?"[Voice message]":null)||(e.document?`[Document: ${e.document.file_name}]`:null)||(e.sticker?`[Sticker: ${e.sticker.emoji||""}]`:null)||(e.location?`[Location: ${e.location.latitude}, ${e.location.longitude}]`:null)||(e.contact?`[Contact: ${e.contact.first_name}]`:null)||"[Unsupported message type]",i=e.from?.first_name||e.from?.username||"Unknown";this.messageCallback?.({id:String(e.message_id),groupId:`tg:${s}`,sender:i,content:n,timestamp:e.date*1e3,channel:"telegram"})}async apiCall(t,e){const s=await fetch(`${R}${this.token}/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){const n=await s.text();throw new Error(`Telegram API ${t} failed: ${s.status} ${n}`)}return s.json()}}function kt(a,t){if(a.length<=t)return[a];const e=[];let s=a;for(;s.length>0;){if(s.length<=t){e.push(s);break}let n=t;const i=s.lastIndexOf(`
`,t);i>t*.5&&(n=i),e.push(s.slice(0,n)),s=s.slice(n)}return e}function L(a){return new Promise(t=>setTimeout(t,a))}class bt{constructor(t,e){this.browserChat=t,this.telegram=e}async send(t,e){const s=this.findChannel(t);if(!s){console.warn(`No channel for groupId: ${t}`);return}await s.send(t,e)}setTyping(t,e){this.findChannel(t)?.setTyping(t,e)}static formatOutbound(t){return t.replace(/<internal>[\s\S]*?<\/internal>/g,"").trim()}static formatMessagesXml(t){const e=n=>n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return`<messages>
${t.map(n=>`<message sender="${e(n.sender)}" time="${new Date(n.timestamp).toISOString()}">${e(n.content)}</message>`).join(`
`)}
</messages>`}findChannel(t){return t.startsWith("tg:")?this.telegram:this.browserChat}}class Ct{interval=null;runner;constructor(t){this.runner=t}start(){this.interval||(this.interval=setInterval(()=>this.tick(),et),this.tick())}stop(){this.interval&&(clearInterval(this.interval),this.interval=null)}async tick(){try{const t=await rt(),e=new Date;for(const s of t)if(Tt(s.schedule,e)&&!this.ranThisMinute(s,e)){await lt(s.id,e.getTime());const n=`[SCHEDULED TASK]

${s.prompt}`;this.runner(s.groupId,n).catch(i=>{console.error(`Task ${s.id} failed:`,i)})}}catch(t){console.error("Scheduler tick error:",t)}}ranThisMinute(t,e){if(!t.lastRun)return!1;const s=new Date(t.lastRun);return s.getFullYear()===e.getFullYear()&&s.getMonth()===e.getMonth()&&s.getDate()===e.getDate()&&s.getHours()===e.getHours()&&s.getMinutes()===e.getMinutes()}}function Tt(a,t){const e=a.trim().split(/\s+/);if(e.length!==5)return!1;const[s,n,i,o,r]=e;return E(s,t.getMinutes())&&E(n,t.getHours())&&E(i,t.getDate())&&E(o,t.getMonth()+1)&&E(r,t.getDay())}function E(a,t){return a==="*"?!0:a.split(",").some(e=>{if(e.includes("/")){const[s,n]=e.split("/"),i=parseInt(n,10);if(isNaN(i)||i<=0)return!1;if(s==="*")return t%i===0;if(s.includes("-")){const[r,c]=s.split("-").map(Number);return t>=r&&t<=c&&(t-r)%i===0}const o=parseInt(s,10);return t>=o&&(t-o)%i===0}if(e.includes("-")){const[s,n]=e.split("-").map(Number);return t>=s&&t<=n}return parseInt(e,10)===t})}class xt{listeners=new Map;on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}off(t,e){this.listeners.get(t)?.delete(e)}emit(t,e){this.listeners.get(t)?.forEach(s=>s(e))}}class St{events=new xt;browserChat=new vt;telegram=new wt;router;scheduler;agentWorker;state="idle";triggerPattern;assistantName=A;apiKey="";model=P;maxTokens=O;messageQueue=[];processing=!1;async init(){await at(),this.assistantName=await u(p.ASSISTANT_NAME)||A,this.triggerPattern=I(this.assistantName);const t=await u(p.ANTHROPIC_API_KEY);if(t)try{this.apiKey=await z(t)}catch{this.apiKey="",await g(p.ANTHROPIC_API_KEY,"")}this.model=await u(p.MODEL)||P,this.maxTokens=parseInt(await u(p.MAX_TOKENS)||String(O),10),this.router=new bt(this.browserChat,this.telegram),this.browserChat.onMessage(s=>this.enqueue(s));const e=await u(p.TELEGRAM_BOT_TOKEN);if(e){const s=await u(p.TELEGRAM_CHAT_IDS),n=s?JSON.parse(s):[];this.telegram.configure(e,n),this.telegram.onMessage(i=>this.enqueue(i)),this.telegram.start()}this.agentWorker=new Worker(new URL("/openbrowserclaw/assets/agent-worker-BuECX4Ew.js",import.meta.url),{type:"module"}),this.agentWorker.onmessage=s=>{this.handleWorkerMessage(s.data)},this.agentWorker.onerror=s=>{console.error("Agent worker error:",s)},this.scheduler=new Ct((s,n)=>this.invokeAgent(s,n)),this.scheduler.start(),this.browserChat.onDisplay((s,n,i)=>{}),this.events.emit("ready",void 0)}getState(){return this.state}isConfigured(){return this.apiKey.length>0}async setApiKey(t){this.apiKey=t;const e=await yt(t);await g(p.ANTHROPIC_API_KEY,e)}getModel(){return this.model}async setModel(t){this.model=t,await g(p.MODEL,t)}getAssistantName(){return this.assistantName}async setAssistantName(t){this.assistantName=t,this.triggerPattern=I(t),await g(p.ASSISTANT_NAME,t)}async configureTelegram(t,e){await g(p.TELEGRAM_BOT_TOKEN,t),await g(p.TELEGRAM_CHAT_IDS,JSON.stringify(e)),this.telegram.configure(t,e),this.telegram.onMessage(s=>this.enqueue(s)),this.telegram.start()}submitMessage(t,e){this.browserChat.submit(t,e)}async newSession(t=f){await U(t),this.events.emit("session-reset",{groupId:t})}async compactContext(t=f){if(!this.apiKey){this.events.emit("error",{groupId:t,error:"API key not configured. Cannot compact context."});return}if(this.state!=="idle"){this.events.emit("error",{groupId:t,error:"Cannot compact while processing. Wait for the current response to finish."});return}this.setState("thinking"),this.events.emit("typing",{groupId:t,typing:!0});let e="";try{e=await F(t,"CLAUDE.md")}catch{}const s=await H(t,_),n=q(this.assistantName,e);this.agentWorker.postMessage({type:"compact",payload:{groupId:t,messages:s,systemPrompt:n,apiKey:this.apiKey,model:this.model,maxTokens:this.maxTokens}})}shutdown(){this.scheduler.stop(),this.telegram.stop(),this.agentWorker.terminate()}setState(t){this.state=t,this.events.emit("state-change",t)}async enqueue(t){const e={...t,isFromMe:!1,isTrigger:!1},s=t.groupId===f,n=this.triggerPattern.test(t.content.trim());(s||n)&&(e.isTrigger=!0,this.messageQueue.push(t)),await S(e),this.events.emit("message",e),this.processQueue()}async processQueue(){if(this.processing||this.messageQueue.length===0)return;if(!this.apiKey){const e=this.messageQueue.shift();this.events.emit("error",{groupId:e.groupId,error:"API key not configured. Go to Settings to add your Anthropic API key."});return}this.processing=!0;const t=this.messageQueue.shift();try{await this.invokeAgent(t.groupId,t.content)}catch(e){console.error("Failed to invoke agent:",e)}finally{this.processing=!1,this.messageQueue.length>0&&this.processQueue()}}async invokeAgent(t,e){this.setState("thinking"),this.router.setTyping(t,!0),this.events.emit("typing",{groupId:t,typing:!0});let s="";try{s=await F(t,"CLAUDE.md")}catch{}const n=await H(t,_),i=q(this.assistantName,s);this.agentWorker.postMessage({type:"invoke",payload:{groupId:t,messages:n,systemPrompt:i,apiKey:this.apiKey,model:this.model,maxTokens:this.maxTokens}})}async handleWorkerMessage(t){switch(t.type){case"response":{const{groupId:e,text:s}=t.payload;if(s.startsWith("__TASK_CREATED__")){const n=s.slice(16);try{const i=JSON.parse(n);await $(i);const o=`‚úÖ Scheduled task created.
Schedule: \`${i.schedule}\`
Prompt: ${i.prompt}`;await this.deliverResponse(e,o)}catch{await this.deliverResponse(e,"‚ö†Ô∏è Failed to create scheduled task.")}break}await this.deliverResponse(e,s);break}case"error":{const{groupId:e,error:s}=t.payload;await this.deliverResponse(e,`‚ö†Ô∏è Error: ${s}`);break}case"typing":{const{groupId:e}=t.payload;this.router.setTyping(e,!0),this.events.emit("typing",{groupId:e,typing:!0});break}case"tool-activity":{this.events.emit("tool-activity",t.payload);break}case"thinking-log":{this.events.emit("thinking-log",t.payload);break}case"compact-done":{await this.handleCompactDone(t.payload.groupId,t.payload.summary);break}case"token-usage":{this.events.emit("token-usage",t.payload);break}}}async handleCompactDone(t,e){await U(t);const s={id:T(),groupId:t,sender:this.assistantName,content:`üìù **Context Compacted**

${e}`,timestamp:Date.now(),channel:t.startsWith("tg:")?"telegram":"browser",isFromMe:!0,isTrigger:!1};await S(s),this.events.emit("context-compacted",{groupId:t,summary:e}),this.events.emit("typing",{groupId:t,typing:!1}),this.setState("idle")}async deliverResponse(t,e){const s={id:T(),groupId:t,sender:this.assistantName,content:e,timestamp:Date.now(),channel:t.startsWith("tg:")?"telegram":"browser",isFromMe:!0,isTrigger:!1};await S(s),await this.router.send(t,e),this.events.emit("message",s),this.events.emit("typing",{groupId:t,typing:!1}),this.setState("idle"),this.router.setTyping(t,!1)}}function q(a,t){const e=[`You are ${a}, a personal AI assistant running in the user's browser.`,"","You have access to the following tools:","- **bash**: Execute commands in a sandboxed Linux VM (Alpine). Use for scripts, text processing, package installation.","- **javascript**: Execute JavaScript code. Lighter than bash ‚Äî no VM boot needed. Use for calculations, data transforms.","- **read_file** / **write_file** / **list_files**: Manage files in the group workspace (persisted in browser storage).","- **fetch_url**: Make HTTP requests (subject to CORS).","- **update_memory**: Persist important context to CLAUDE.md ‚Äî loaded on every conversation.","- **create_task**: Schedule recurring tasks with cron expressions.","","Guidelines:","- Be concise and direct.","- Use tools proactively when they help answer the question.","- Update memory when you learn important preferences or context.","- For scheduled tasks, confirm the schedule with the user.","- Strip <internal> tags from your responses ‚Äî they are for your internal reasoning only."];return t&&e.push("","## Persistent Memory","",t),e.join(`
`)}function Lt(a){const t=a.replace(/\r\n/g,`
`).replace(/\r/g,`
`),e=[],n=t.replace(/^```(\w*)\n([\s\S]*?)^```$/gm,(r,c,h)=>{const d=e.length,x=D(h.replace(/\n$/,"")),J=c?` class="language-${D(c)}"`:"";return e.push(`<pre><code${J}>${x}</code></pre>`),`\0CODE${d}\0`}).split(`
`);let o=X(n);for(let r=0;r<e.length;r++)o=o.replace(`\0CODE${r}\0`,e[r]);return o}function X(a){const t=[];let e=0;for(;e<a.length;){const s=a[e];if(/^\x00CODE\d+\x00$/.test(s)){t.push(s),e++;continue}if(s.trim()===""){e++;continue}const n=s.match(/^(#{1,6})\s+(.*)/);if(n){const i=n[1].length;t.push(`<h${i}>${w(n[2])}</h${i}>`),e++;continue}if(/^(\*{3,}|-{3,}|_{3,})\s*$/.test(s.trim())){t.push("<hr>"),e++;continue}if(e+1<a.length&&Mt(a[e+1])){const i=[s];let o=e+1;for(;o<a.length&&a[o].trim()!==""&&a[o].includes("|");)i.push(a[o]),o++;t.push(At(i)),e=o;continue}if(s.startsWith(">")){const i=[];let o=e;for(;o<a.length&&(a[o].startsWith(">")||a[o].trim()!==""&&i.length>0&&!a[o].startsWith("#"))&&a[o].startsWith(">");){i.push(a[o].replace(/^>\s?/,""));o++}t.push(`<blockquote>${X(i)}</blockquote>`),e=o;continue}if(/^[\s]*[-*+]\s/.test(s)){const{html:i,consumed:o}=W(a,e,"ul");t.push(i),e+=o;continue}if(/^[\s]*\d+\.\s/.test(s)){const{html:i,consumed:o}=W(a,e,"ol");t.push(i),e+=o;continue}if(s.trim().startsWith("<svg")){const i=[];let o=e,r=0;for(;o<a.length&&(i.push(a[o]),r+=(a[o].match(/<svg[\s>]/g)||[]).length,r-=(a[o].match(/<\/svg>/g)||[]).length,o++,!(r<=0)););t.push(It(i.join(`
`))),e=o;continue}{const i=[];let o=e;for(;o<a.length;){const r=a[o];if(r.trim()===""||/^(#{1,6}\s|>\s?|[-*+]\s|\d+\.\s|```|\x00CODE)/.test(r)||r.trim().startsWith("<svg"))break;i.push(r),o++}i.length>0?(t.push(`<p>${w(i.join(`
`))}</p>`),e=o):e++}}return t.join(`
`)}function Mt(a){return/^\|?[\s]*:?-+:?[\s]*(\|[\s]*:?-+:?[\s]*)*\|?$/.test(a.trim())}function At(a){if(a.length<2)return"";const t=o=>o.replace(/^\|/,"").replace(/\|$/,"").split("|").map(r=>r.trim()),e=t(a[0]),n=t(a[1]).map(o=>{const r=o.startsWith(":"),c=o.endsWith(":");return r&&c?"center":c?"right":"left"});let i="<table><thead><tr>";for(let o=0;o<e.length;o++){const r=n[o]?` style="text-align:${n[o]}"`:"";i+=`<th${r}>${w(e[o])}</th>`}i+="</tr></thead><tbody>";for(let o=2;o<a.length;o++){const r=t(a[o]);i+="<tr>";for(let c=0;c<e.length;c++){const h=n[c]?` style="text-align:${n[c]}"`:"";i+=`<td${h}>${w(r[c]??"")}</td>`}i+="</tr>"}return i+="</tbody></table>",i}function W(a,t,e){const s=[];let n=t;const i=e==="ul"?/^(\s*)[-*+]\s(.*)/:/^(\s*)\d+\.\s(.*)/;for(;n<a.length;){const r=a[n].match(i);if(r)s.push(r[2]),n++;else if(a[n].trim()===""){if(n+1<a.length&&i.test(a[n+1])){n++;continue}break}else if(a[n].startsWith("  ")||a[n].startsWith("	"))s.length>0&&(s[s.length-1]+=`
`+a[n].replace(/^\s{2,}|\t/,"")),n++;else break}const o=s.map(r=>`<li>${w(r)}</li>`).join("");return{html:`<${e}>${o}</${e}>`,consumed:n-t}}function w(a){let t=a;return t=D(t),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,(e,s,n)=>{const i=M(V(n)),o=M(s);return`<img src="${i}" alt="${o}" loading="lazy">`}),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,s,n)=>`<a href="${M(V(n))}" target="_blank" rel="noopener">${s}</a>`),t=t.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/_(.+?)_/g,"<em>$1</em>"),t=t.replace(/~~(.+?)~~/g,"<del>$1</del>"),t=t.replace(/ {2,}\n/g,"<br>"),t=t.replace(/\n/g,"<br>"),t}function It(a){let t=a.replace(/<script[\s\S]*?<\/script>/gi,"");t=t.replace(/\s+on\w+\s*=\s*("[^"]*"|'[^']*'|[^\s>]*)/gi,""),t=t.replace(/href\s*=\s*["']javascript:[^"']*["']/gi,""),t=t.replace(/xlink:href\s*=\s*["']javascript:[^"']*["']/gi,"");const e=t.match(/<svg([^>]*)>/i);if(e){let s=e[1];const n=/viewBox/i.test(s),i=s.match(/\bwidth\s*=\s*["']?(\d+(?:\.\d+)?)/i),o=s.match(/\bheight\s*=\s*["']?(\d+(?:\.\d+)?)/i);!n&&i&&o&&(s+=` viewBox="0 0 ${i[1]} ${o[1]}"`),s=s.replace(/\bwidth\s*=\s*("[^"]*"|'[^']*'|\S+)/gi,""),s=s.replace(/\bheight\s*=\s*("[^"]*"|'[^']*'|\S+)/gi,""),t=t.replace(/<svg[^>]*>/i,`<svg${s}>`)}return`<div class="md-svg">${t}</div>`}function D(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function M(a){return a.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function V(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"')}class _t{orchestrator;container=null;messagesEl=null;inputEl=null;typingEl=null;toolEl=null;sendBtn=null;activeGroupId=f;isTyping=!1;activityLogEl=null;activityListEl=null;activityToggleEl=null;activityExpanded=!1;activityEntries=[];contextBarEl=null;contextFillEl=null;contextLabelEl=null;constructor(t){this.orchestrator=t}mount(t){this.container=t,this.container.classList.add("chat-container"),this.render()}addMessage(t){t.groupId===this.activeGroupId&&(this.appendMessageEl(t),this.scrollToBottom())}setTyping(t,e){t===this.activeGroupId&&(this.isTyping=e,this.typingEl&&(this.typingEl.style.display=e?"flex":"none"),this.activityLogEl&&(e?this.activityLogEl.style.display="block":this.activityLogEl.style.display="none"),e&&this.scrollToBottom())}setToolActivity(t,e){this.toolEl&&(e==="running"?(this.toolEl.textContent=`Using ${t}...`,this.toolEl.style.display="block"):this.toolEl.style.display="none")}addThinkingLog(t){t.groupId===this.activeGroupId&&(t.kind==="info"&&t.label==="Starting"&&(this.activityEntries=[],this.activityListEl&&(this.activityListEl.innerHTML="")),this.activityEntries.push(t),this.renderLogEntry(t),this.scrollToBottom())}setState(t){this.inputEl&&(this.inputEl.disabled=t==="thinking"),this.sendBtn&&(this.sendBtn.disabled=t==="thinking")}showError(t){const e=l("div","message message-error");e.textContent=`‚ö†Ô∏è ${t}`,this.messagesEl?.appendChild(e),this.scrollToBottom()}updateTokenUsage(t){if(t.groupId!==this.activeGroupId||!this.contextBarEl||!this.contextFillEl||!this.contextLabelEl)return;const e=t.inputTokens+t.outputTokens,s=t.contextLimit,n=Math.min(e/s*100,100);this.contextFillEl.style.width=`${n}%`,this.contextFillEl.classList.remove("context-fill-ok","context-fill-warn","context-fill-danger"),n>=80?this.contextFillEl.classList.add("context-fill-danger"):n>=60?this.contextFillEl.classList.add("context-fill-warn"):this.contextFillEl.classList.add("context-fill-ok");const i=(e/1e3).toFixed(1),o=(s/1e3).toFixed(0);this.contextLabelEl.textContent=`${i}k / ${o}k tokens (${n.toFixed(0)}%)`,this.contextBarEl.style.display="flex"}clearMessages(){this.messagesEl&&(this.messagesEl.innerHTML=""),this.activityEntries=[],this.activityListEl&&(this.activityListEl.innerHTML=""),this.contextBarEl&&(this.contextBarEl.style.display="none"),this.contextFillEl&&(this.contextFillEl.style.width="0%")}async loadHistory(){try{const t=await Y(this.activeGroupId,_);this.messagesEl&&(this.messagesEl.innerHTML="");for(const e of t)this.appendMessageEl(e);this.scrollToBottom()}catch(t){console.error("Failed to load history:",t)}}render(){if(!this.container)return;this.container.innerHTML="";const t=l("div","chat-actions");this.contextBarEl=l("div","context-bar"),this.contextBarEl.style.display="none";const e=l("div","context-track");this.contextFillEl=l("div","context-fill context-fill-ok"),e.appendChild(this.contextFillEl),this.contextLabelEl=l("span","context-label"),this.contextLabelEl.textContent="0k / 30k tokens",this.contextBarEl.append(e,this.contextLabelEl),t.appendChild(this.contextBarEl);const s=l("div","chat-actions-spacer");t.appendChild(s);const n=document.createElement("button");n.className="chat-action-btn",n.title="Summarize conversation to reduce context size",n.innerHTML="üìâ Compact",n.addEventListener("click",()=>{confirm("Summarize the current conversation to reduce token usage? The full history will be replaced with a compact summary.")&&this.orchestrator.compactContext(this.activeGroupId)});const i=document.createElement("button");i.className="chat-action-btn chat-action-btn-danger",i.title="Clear all messages and start fresh",i.innerHTML="üóëÔ∏è New Session",i.addEventListener("click",()=>{confirm("Start a new session? This will clear all messages in the current conversation.")&&this.orchestrator.newSession(this.activeGroupId)}),t.append(n,i),this.container.appendChild(t),this.messagesEl=l("div","messages"),this.container.appendChild(this.messagesEl),this.typingEl=l("div","typing-indicator"),this.typingEl.innerHTML=`
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
      <span class="typing-text">Thinking...</span>
    `,this.typingEl.style.display="none",this.container.appendChild(this.typingEl),this.toolEl=l("div","tool-activity"),this.toolEl.style.display="none",this.container.appendChild(this.toolEl),this.activityLogEl=l("div","activity-log"),this.activityLogEl.style.display="none",this.activityToggleEl=l("div","activity-toggle"),this.activityToggleEl.innerHTML='<span class="activity-toggle-icon">‚ñ∂</span> Activity',this.activityToggleEl.addEventListener("click",()=>{if(this.activityExpanded=!this.activityExpanded,this.activityListEl&&(this.activityListEl.style.display=this.activityExpanded?"block":"none"),this.activityToggleEl){const r=this.activityToggleEl.querySelector(".activity-toggle-icon");r&&(r.textContent=this.activityExpanded?"‚ñº":"‚ñ∂")}this.activityExpanded&&this.scrollToBottom()}),this.activityLogEl.appendChild(this.activityToggleEl),this.activityListEl=l("div","activity-list"),this.activityListEl.style.display="none",this.activityLogEl.appendChild(this.activityListEl),this.container.appendChild(this.activityLogEl);const o=l("div","input-area");this.inputEl=document.createElement("textarea"),this.inputEl.className="chat-input",this.inputEl.placeholder="Type a message...",this.inputEl.rows=1,this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),this.handleSend())}),this.inputEl.addEventListener("input",()=>{this.inputEl&&(this.inputEl.style.height="auto",this.inputEl.style.height=Math.min(this.inputEl.scrollHeight,150)+"px")}),this.sendBtn=document.createElement("button"),this.sendBtn.className="send-btn",this.sendBtn.textContent="‚Üí",this.sendBtn.addEventListener("click",()=>this.handleSend()),o.append(this.inputEl,this.sendBtn),this.container.appendChild(o)}handleSend(){if(!this.inputEl)return;const t=this.inputEl.value.trim();t&&(this.orchestrator.submitMessage(t,this.activeGroupId),this.inputEl.value="",this.inputEl.style.height="auto",this.inputEl.focus())}appendMessageEl(t){if(!this.messagesEl)return;const e=l("div",`message ${t.isFromMe?"message-assistant":"message-user"}`),s=l("div","message-sender");s.textContent=t.isFromMe?this.orchestrator.getAssistantName():t.sender,e.appendChild(s);const n=l("div","message-content");t.isFromMe?(n.classList.add("md"),n.innerHTML=Lt(t.content)):n.textContent=t.content,e.appendChild(n);const i=l("div","message-time");i.textContent=$t(t.timestamp),e.appendChild(i),this.messagesEl.appendChild(e)}renderLogEntry(t){if(!this.activityListEl)return;const e=l("div",`activity-entry activity-${t.kind}`),s={"api-call":"üîó","tool-call":"üîß","tool-result":"üìã",text:"üí¨",info:"‚ÑπÔ∏è"},n=new Date(t.timestamp).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=l("div","activity-entry-header");if(i.innerHTML=`<span class="activity-icon">${s[t.kind]||"‚Ä¢"}</span><span class="activity-label">${Nt(t.label)}</span><span class="activity-time">${n}</span>`,e.appendChild(i),t.detail){const o=l("div","activity-detail");o.textContent=t.detail,t.detail.length>120&&(o.classList.add("activity-detail-collapsed"),o.addEventListener("click",()=>{o.classList.toggle("activity-detail-collapsed"),o.classList.toggle("activity-detail-expanded"),this.scrollToBottom()})),e.appendChild(o)}if(this.activityListEl.appendChild(e),this.activityToggleEl){const r=this.activityToggleEl.querySelector(".activity-toggle-icon")?.textContent||"‚ñ∂";this.activityToggleEl.innerHTML=`<span class="activity-toggle-icon">${r}</span> Activity (${this.activityEntries.length})`}}scrollToBottom(){this.messagesEl&&(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}}function $t(a){return new Date(a).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}function Nt(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class Bt{orchestrator;container=null;onDone;constructor(t,e){this.orchestrator=t,this.onDone=e}mount(t){this.container=t,this.container.classList.add("settings-container"),this.render()}render(){if(!this.container)return;this.container.innerHTML="";const t=l("div","settings-wrapper"),e=l("h2","settings-title");e.textContent="Settings",t.appendChild(e),t.appendChild(this.createSection("Anthropic API Key",n=>{const i=document.createElement("input");i.type="password",i.className="settings-input",i.placeholder="sk-ant-...",i.id="api-key-input",u(p.ANTHROPIC_API_KEY).then(async h=>{if(h)try{i.value=await z(h)}catch{i.value=""}});const o=document.createElement("button");o.className="settings-btn",o.textContent="Save",o.addEventListener("click",async()=>{const h=i.value.trim();h&&(await this.orchestrator.setApiKey(h),this.showStatus(n,"‚úì API key saved"))});const r=l("p","settings-hint"),c=document.createElement("a");c.href="https://platform.claude.com/settings/keys",c.target="_blank",c.rel="noopener noreferrer",c.textContent="Get your API key here",r.append(c,". Stored locally in your browser."),n.append(i,o,r)})),t.appendChild(this.createSection("Model",n=>{const i=document.createElement("select");i.className="settings-select",i.id="model-select";const o=["claude-opus-4-6","claude-sonnet-4-6","claude-haiku-4-5-20251001"],r=this.orchestrator.getModel();for(const c of o){const h=document.createElement("option");h.value=c,h.textContent=c,h.selected=c===r,i.appendChild(h)}i.addEventListener("change",async()=>{await this.orchestrator.setModel(i.value),this.showStatus(n,"‚úì Model updated")}),n.appendChild(i)})),t.appendChild(this.createSection("Assistant Name",n=>{const i=document.createElement("input");i.type="text",i.className="settings-input",i.placeholder="Andy",i.value=this.orchestrator.getAssistantName();const o=document.createElement("button");o.className="settings-btn",o.textContent="Save",o.addEventListener("click",async()=>{const c=i.value.trim();c&&(await this.orchestrator.setAssistantName(c),this.showStatus(n,`‚úì Assistant name set to ${c}`))});const r=l("p","settings-hint");r.textContent=`Trigger pattern: @${i.value||"Andy"}. In the main chat, no trigger is needed.`,i.addEventListener("input",()=>{r.textContent=`Trigger pattern: @${i.value||"Andy"}. In the main chat, no trigger is needed.`}),n.append(i,o,r)})),t.appendChild(this.createSection("Telegram (Optional)",n=>{const i=document.createElement("input");i.type="password",i.className="settings-input",i.placeholder="Bot token from @BotFather",i.id="tg-token-input";const o=document.createElement("input");o.type="text",o.className="settings-input",o.placeholder="Chat IDs (comma-separated)",o.id="tg-chatids-input",u(p.TELEGRAM_BOT_TOKEN).then(h=>{h&&(i.value=h)}),u(p.TELEGRAM_CHAT_IDS).then(h=>{if(h)try{o.value=JSON.parse(h).join(", ")}catch{}});const r=document.createElement("button");r.className="settings-btn",r.textContent="Connect Telegram",r.addEventListener("click",async()=>{const h=i.value.trim(),d=o.value.split(",").map(x=>x.trim()).filter(Boolean);h&&(await this.orchestrator.configureTelegram(h,d),this.showStatus(n,"‚úì Telegram connected"))});const c=l("p","settings-hint");c.innerHTML="Create a bot with <code>@BotFather</code> on Telegram. Send <code>/chatid</code> to your bot to get the chat ID.",n.append(i,o,r,c)})),t.appendChild(this.createSection("Storage",n=>{const i=l("div","storage-info");i.id="storage-info",i.textContent="Loading...",n.appendChild(i);const o=document.createElement("button");o.className="settings-btn",o.textContent="Request Persistent Storage",o.addEventListener("click",async()=>{const r=await ut();this.showStatus(n,r?"‚úì Persistent storage granted":"‚úó Browser denied persistent storage")}),n.appendChild(o),gt().then(({usage:r,quota:c})=>{const h=(r/1024/1024).toFixed(1),d=(c/1024/1024).toFixed(0);i.textContent=`Using ${h} MB of ${d} MB (${(r/c*100).toFixed(1)}%)`})}));const s=document.createElement("button");s.className="settings-btn settings-btn-primary",s.textContent="Done",s.addEventListener("click",()=>this.onDone()),t.appendChild(s),this.container.appendChild(t)}createSection(t,e){const s=l("div","settings-section"),n=l("h3","settings-section-title");return n.textContent=t,s.appendChild(n),e(s),s}showStatus(t,e){let s=t.querySelector(".settings-status");s||(s=l("div","settings-status"),t.appendChild(s)),s.textContent=e,setTimeout(()=>{s.textContent=""},3e3)}}class Dt{orchestrator;container=null;listEl=null;constructor(t){this.orchestrator=t}mount(t){this.container=t,this.container.classList.add("tasks-container"),this.render(),this.loadTasks()}render(){if(!this.container)return;this.container.innerHTML="";const t=l("div","tasks-wrapper"),e=l("div","tasks-header"),s=l("h2","tasks-title");s.textContent="Scheduled Tasks",e.appendChild(s);const n=document.createElement("button");n.className="settings-btn",n.textContent="+ New Task",n.addEventListener("click",()=>this.showAddForm()),e.appendChild(n),t.appendChild(e),this.listEl=l("div","tasks-list"),t.appendChild(this.listEl),this.container.appendChild(t)}async loadTasks(){if(!this.listEl)return;const t=await ct();if(t.length===0){this.listEl.innerHTML='<div class="tasks-empty">No scheduled tasks yet. Create one with the button above, or ask your assistant to schedule something.</div>';return}this.listEl.innerHTML="";for(const e of t)this.listEl.appendChild(this.renderTask(e))}renderTask(t){const e=l("div","task-item"),s=l("div","task-info"),n=l("div","task-schedule");n.textContent=`‚è∞ ${t.schedule}`,s.appendChild(n);const i=l("div","task-prompt");i.textContent=t.prompt,s.appendChild(i);const o=l("div","task-meta");o.textContent=`Group: ${t.groupId} ¬∑ ${t.enabled?"‚úÖ Active":"‚è∏ Paused"}`,t.lastRun&&(o.textContent+=` ¬∑ Last run: ${new Date(t.lastRun).toLocaleString()}`),s.appendChild(o),e.appendChild(s);const r=l("div","task-actions"),c=document.createElement("button");c.className="task-btn",c.textContent=t.enabled?"Pause":"Resume",c.addEventListener("click",async()=>{t.enabled=!t.enabled,await $(t),await this.loadTasks()});const h=document.createElement("button");return h.className="task-btn task-btn-danger",h.textContent="Delete",h.addEventListener("click",async()=>{await ot(t.id),await this.loadTasks()}),r.append(c,h),e.appendChild(r),e}showAddForm(){if(!this.listEl)return;const t=this.listEl.querySelector(".task-form");if(t){t.remove();return}const e=l("div","task-form"),s=document.createElement("input");s.type="text",s.className="settings-input",s.placeholder="Cron: 0 9 * * 1-5 (9am weekdays)";const n=document.createElement("textarea");n.className="settings-input task-prompt-input",n.placeholder="What should the assistant do?",n.rows=3;const i=l("div","task-form-btns"),o=document.createElement("button");o.className="settings-btn settings-btn-primary",o.textContent="Create",o.addEventListener("click",async()=>{const c=s.value.trim(),h=n.value.trim();if(!c||!h)return;const d={id:T(),groupId:f,schedule:c,prompt:h,enabled:!0,lastRun:null,createdAt:Date.now()};await $(d),e.remove(),await this.loadTasks()});const r=document.createElement("button");r.className="settings-btn",r.textContent="Cancel",r.addEventListener("click",()=>e.remove()),i.append(o,r),e.append(s,n,i),this.listEl.prepend(e)}}class Ot{orchestrator;chatUI;settingsUI;tasksUI;currentView="chat";root;constructor(t){this.root=t,this.orchestrator=new St,this.chatUI=new _t(this.orchestrator),this.settingsUI=new Bt(this.orchestrator,()=>this.navigate("chat")),this.tasksUI=new Dt(this.orchestrator)}async init(){this.orchestrator.events.on("message",t=>{this.chatUI.addMessage(t)}),this.orchestrator.events.on("typing",({groupId:t,typing:e})=>{this.chatUI.setTyping(t,e)}),this.orchestrator.events.on("tool-activity",({tool:t,status:e})=>{this.chatUI.setToolActivity(t,e)}),this.orchestrator.events.on("thinking-log",t=>{this.chatUI.addThinkingLog(t)}),this.orchestrator.events.on("state-change",t=>{this.chatUI.setState(t)}),this.orchestrator.events.on("error",({error:t})=>{this.chatUI.showError(t)}),this.orchestrator.events.on("session-reset",()=>{this.chatUI.clearMessages()}),this.orchestrator.events.on("context-compacted",()=>{this.chatUI.clearMessages(),this.chatUI.loadHistory()}),this.orchestrator.events.on("token-usage",t=>{this.chatUI.updateTokenUsage(t)});try{await this.orchestrator.init()}catch(t){console.error("Failed to initialize:",t)}this.render(),this.orchestrator.isConfigured()||this.navigate("settings"),await this.chatUI.loadHistory()}navigate(t){this.currentView=t,this.updateView()}render(){this.root.innerHTML="",this.root.className="app";const t=l("header","app-header"),e=l("div","app-logo");e.innerHTML='<span class="app-logo-icon">ü¶Ä</span> OpenBrowserClaw',t.appendChild(e);const s=l("nav","app-nav"),n=this.navButton("üí¨","Chat","chat"),i=this.navButton("‚è∞","Tasks","tasks"),o=this.navButton("‚öôÔ∏è","Settings","settings");s.append(n,i,o),t.appendChild(s),this.root.appendChild(t);const r=l("main","app-content");r.id="app-content";const c=l("div","view");c.id="view-chat",this.chatUI.mount(c);const h=l("div","view");h.id="view-settings",this.settingsUI.mount(h);const d=l("div","view");d.id="view-tasks",this.tasksUI.mount(d),r.append(c,h,d),this.root.appendChild(r),this.updateView()}navButton(t,e,s){const n=document.createElement("button");return n.className="nav-btn",n.dataset.view=s,n.innerHTML=`<span class="nav-icon">${t}</span><span class="nav-label">${e}</span>`,n.addEventListener("click",()=>this.navigate(s)),n}updateView(){const t=["chat","settings","tasks"];for(const s of t){const n=document.getElementById(`view-${s}`);n&&(n.style.display=s===this.currentView?"flex":"none")}this.root.querySelectorAll(".nav-btn").forEach(s=>{const n=s.dataset.view;s.classList.toggle("active",n===this.currentView)})}}function l(a,t){const e=document.createElement(a);return t&&(e.className=t),e}async function Pt(){const a=document.getElementById("app");if(!a)throw new Error("Missing #app element");await new Ot(a).init()}Pt().catch(a=>{console.error("OpenBrowserClaw failed to start:",a),document.body.innerHTML=`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #0f0f23;
      color: #ff6b6b;
      font-family: monospace;
      padding: 20px;
      text-align: center;
    ">
      <div>
        <h1>OpenBrowserClaw failed to start</h1>
        <p style="color: #8892b0; margin-top: 12px;">${a instanceof Error?a.message:String(a)}</p>
        <p style="color: #5a6080; margin-top: 8px; font-size: 12px;">Check the browser console for details.</p>
      </div>
    </div>
  `});
