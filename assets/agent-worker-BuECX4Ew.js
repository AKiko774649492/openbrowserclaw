const J=[{name:"bash",description:'Execute a shell command in a lightweight bash emulator. Supports common commands: echo, cat, head, tail, grep, sort, sed, awk, cut, tr, uniq, wc, ls, mkdir, cp, mv, rm, touch, pwd, cd, date, sleep, seq, jq, base64, tee, xargs, test, basename, dirname. Supports pipes (|), redirects (> >>), operators (&& || ;), and variable expansion ($VAR). Uses the group workspace filesystem. For complex logic, prefer the "javascript" tool. For HTTP requests, use the "fetch_url" tool.',input_schema:{type:"object",properties:{command:{type:"string",description:"The bash command to execute"},timeout:{type:"number",description:"Timeout in seconds (default: 30, max: 120)"}},required:["command"]}},{name:"read_file",description:"Read the contents of a file from the group workspace. Returns the full text content of the file.",input_schema:{type:"object",properties:{path:{type:"string",description:"File path relative to the group workspace root"}},required:["path"]}},{name:"write_file",description:"Write content to a file in the group workspace. Creates the file and any intermediate directories if they don't exist. Overwrites the file if it already exists.",input_schema:{type:"object",properties:{path:{type:"string",description:"File path relative to the group workspace root"},content:{type:"string",description:"Content to write to the file"}},required:["path","content"]}},{name:"list_files",description:"List files and directories in the group workspace. Directory names end with /. Returns sorted entries.",input_schema:{type:"object",properties:{path:{type:"string",description:"Directory path relative to workspace root (default: root)"}}}},{name:"fetch_url",description:"Fetch a URL via HTTP and return the response body. Subject to browser CORS restrictions — works with most public APIs. Response is truncated to 100KB.",input_schema:{type:"object",properties:{url:{type:"string",description:"The URL to fetch"},method:{type:"string",description:"HTTP method (default: GET)"},headers:{type:"object",description:"Request headers as key-value pairs"},body:{type:"string",description:"Request body (for POST/PUT/PATCH)"}},required:["url"]}},{name:"update_memory",description:"Update the CLAUDE.md memory file for this group. Use this to persist important context, user preferences, project state, and anything the agent should remember across conversations. This file is loaded as system context on every invocation.",input_schema:{type:"object",properties:{content:{type:"string",description:"New content for the CLAUDE.md memory file"}},required:["content"]}},{name:"create_task",description:"Create a scheduled recurring task. The task will run automatically on the specified schedule and send the result back to this group. Uses cron expressions (minute hour day-of-month month day-of-week).",input_schema:{type:"object",properties:{schedule:{type:"string",description:'Cron expression, e.g. "0 9 * * 1-5" for 9am weekdays'},prompt:{type:"string",description:"The prompt/instruction to execute on each run"}},required:["schedule","prompt"]}},{name:"javascript",description:"Execute JavaScript code in a sandboxed context and return the result. Lighter than bash — no VM boot required. Use for calculations, data transformations, JSON processing, etc. Has access to standard JS built-ins but no DOM or network.",input_schema:{type:"object",properties:{code:{type:"string",description:"JavaScript code to execute. The return value of the last expression is captured."}},required:["code"]}}],M="https://api.anthropic.com/v1/messages",F="2023-06-01",L=1e5,B="openbrowserclaw";async function W(a,...e){let n=a;for(const o of e)n=await n.getDirectoryHandle(o,{create:!0});return n}async function I(a){const e=await navigator.storage.getDirectory(),n=a.replace(/:/g,"-");return W(e,B,"groups",n)}function C(a){const n=a.replace(/\\/g,"/").replace(/^\/+/,"").split("/").filter(Boolean);if(n.length===0)throw new Error("Empty file path");const o=n.pop();return{dirs:n,filename:o}}async function E(a,e){const n=await I(a),{dirs:o,filename:r}=C(e);let c=n;for(const i of o)c=await c.getDirectoryHandle(i);return(await(await c.getFileHandle(r)).getFile()).text()}async function b(a,e,n){const o=await I(a),{dirs:r,filename:c}=C(e);let t=o;for(const l of r)t=await t.getDirectoryHandle(l,{create:!0});const i=await(await t.getFileHandle(c,{create:!0})).createWritable();await i.write(n),await i.close()}async function O(a,e="."){let o=await I(a);if(e&&e!=="."){const c=e.replace(/\\/g,"/").replace(/^\/+/,"").split("/").filter(Boolean);for(const t of c)o=await o.getDirectoryHandle(t)}const r=[];for await(const[c,t]of o.entries())r.push(t.kind==="directory"?`${c}/`:c);return r.sort()}async function R(a,e){const n=await I(a),{dirs:o,filename:r}=C(e);let c=n;for(const t of o)c=await c.getDirectoryHandle(t);await c.removeEntry(r)}async function G(a,e){try{return await E(a,e),!0}catch{return!1}}async function z(a,e,n={},o=30){const r={groupId:e,cwd:".",env:{HOME:"/workspace",PATH:"/usr/bin",PWD:"/workspace",...n},timeoutMs:o*1e3,startedAt:Date.now()};try{return await K(a.trim(),r)}catch(c){return{stdout:"",stderr:c instanceof Error?c.message:String(c),exitCode:1}}}async function K(a,e){const n=V(a);let o={stdout:"",stderr:"",exitCode:0};for(const r of n){D(e);const{cmd:c,op:t}=r;if(c.trim()&&(c.includes("|")&&!c.includes("||")?o=await X(c,e):o=await A(c.trim(),e),t==="&&"&&o.exitCode!==0||t==="||"&&o.exitCode===0))break}return o}function V(a){const e=[];let n="",o=0,r=!1,c=!1;for(;o<a.length;){const t=a[o];if(t==="'"&&!c){r=!r,n+=t,o++;continue}if(t==='"'&&!r){c=!c,n+=t,o++;continue}if(r||c){n+=t,o++;continue}if(t==="&"&&a[o+1]==="&"){e.push({cmd:n,op:"&&"}),n="",o+=2;continue}if(t==="|"&&a[o+1]==="|"){e.push({cmd:n,op:"||"}),n="",o+=2;continue}if(t===";"){e.push({cmd:n,op:";"}),n="",o++;continue}n+=t,o++}return n.trim()&&e.push({cmd:n,op:""}),e}async function X(a,e){const n=a.split(/(?<!\|)\|(?!\|)/).map(r=>r.trim()).filter(Boolean);let o={stdout:"",stderr:"",exitCode:0};for(const r of n)D(e),o=await A(r,e,o.stdout);return o}async function A(a,e,n=""){D(e);let o=null,r=null,c=a;const t=c.match(/\s*>>\s*(\S+)\s*$/);if(t)o=t[1],c=c.slice(0,t.index);else{const p=c.match(/\s*>\s*(\S+)\s*$/);p&&(r=p[1],c=c.slice(0,p.index))}c=Y(c,e.env);const s=ee(c);if(s.length===0)return{stdout:"",stderr:"",exitCode:0};const i=s[0],l=s.slice(1);if(/^[A-Za-z_]\w*=/.test(i)&&l.length===0){const p=i.indexOf("=");return e.env[i.slice(0,p)]=i.slice(p+1),{stdout:"",stderr:"",exitCode:0}}const u=await Z(i,l,e,n);if(r)return await b(e.groupId,f(r,e),u.stdout),{stdout:"",stderr:u.stderr,exitCode:u.exitCode};if(o){const p=f(o,e),d=await g(e.groupId,p);return await b(e.groupId,p,d+u.stdout),{stdout:"",stderr:u.stderr,exitCode:u.exitCode}}return u}async function Z(a,e,n,o){const r=t=>({stdout:t,stderr:"",exitCode:0}),c=(t,s=1)=>({stdout:"",stderr:t,exitCode:s});switch(a){case"echo":return r(e.join(" ")+`
`);case"printf":{if(e.length===0)return r("");const t=e[0],s=e.slice(1);let i=t,l=0;return i=i.replace(/%[sd]/g,()=>s[l++]??""),i=i.replace(/\\n/g,`
`).replace(/\\t/g,"	"),r(i)}case"cat":{if(e.length===0&&o)return r(o);const t=[];for(const s of e){if(s==="-"){t.push(o);continue}const i=await g(n.groupId,f(s,n));if(i===null)return c(`cat: ${s}: No such file`);t.push(i)}return r(t.join(""))}case"head":{const{flags:t,operands:s}=v(e,["n"]),i=parseInt(t.n??"10",10),l=s.length>0?await g(n.groupId,f(s[0],n))??"":o;return r(l.split(`
`).slice(0,i).join(`
`)+`
`)}case"tail":{const{flags:t,operands:s}=v(e,["n"]),i=parseInt(t.n??"10",10),u=(s.length>0?await g(n.groupId,f(s[0],n))??"":o).split(`
`);return r(u.slice(Math.max(0,u.length-i)).join(`
`))}case"wc":{const t=e.length>0?await g(n.groupId,f(e[0],n))??"":o,s=t.split(`
`).length-(t.endsWith(`
`)?1:0),i=t.split(/\s+/).filter(Boolean).length,l=t.length;return r(`${s} ${i} ${l}
`)}case"grep":{const{flags:t,operands:s}=v(e,["e","m"],["i","v","c","n","l"]),i=t.e??s.shift()??"",l=s.length>0?await g(n.groupId,f(s[0],n))??"":o,u=new RegExp(i,t.i!==void 0?"i":""),p=t.v!==void 0;let d=l.split(`
`).filter(h=>{const m=u.test(h);return p?!m:m});if(t.m!==void 0&&(d=d.slice(0,parseInt(t.m,10))),t.c!==void 0)return r(String(d.length)+`
`);if(t.n!==void 0){const h=l.split(`
`);d=d.map(m=>`${h.indexOf(m)+1}:${m}`)}return d.length>0?r(d.join(`
`)+`
`):c("",1)}case"sort":{const{flags:t,operands:s}=v(e,[],["r","n","u"]);let l=(s.length>0?await g(n.groupId,f(s[0],n))??"":o).split(`
`).filter(Boolean);return t.n!==void 0?l.sort((u,p)=>parseFloat(u)-parseFloat(p)):l.sort(),t.r!==void 0&&l.reverse(),t.u!==void 0&&(l=[...new Set(l)]),r(l.join(`
`)+`
`)}case"uniq":{const s=(e.length>0?await g(n.groupId,f(e[0],n))??"":o).split(`
`),i=s.filter((l,u)=>u===0||l!==s[u-1]);return r(i.join(`
`))}case"tr":{const t=o;if(e[0]==="-d"&&e[1]){const s=e[1];return r(t.replace(new RegExp(`[${N(s)}]`,"g"),""))}if(e.length>=2){const s=e[0],i=e[1];let l=t;for(let u=0;u<s.length;u++){const p=u<i.length?i[u]:i[i.length-1];l=l.replace(new RegExp(N(s[u]),"g"),p)}return r(l)}return c("tr: missing operands")}case"cut":{const{flags:t,operands:s}=v(e,["d","f"]),i=t.d??"	",l=(t.f??"1").split(",").map(d=>parseInt(d,10)-1),p=(s.length>0?await g(n.groupId,f(s[0],n))??"":o).split(`
`).map(d=>{const h=d.split(i);return l.map(m=>h[m]??"").join(i)});return r(p.join(`
`))}case"sed":{const t=e[0]??"",s=e.length>1?await g(n.groupId,f(e[1],n))??"":o,i=t.match(/^s(.)(.+?)\1(.*?)\1([gi]*)$/);if(!i)return c(`sed: unsupported expression: ${t}`);const[,,l,u,p]=i,d=new RegExp(l,p.includes("i")?"gi":p.includes("g")?"g":"");return r(s.replace(d,u))}case"awk":{const t=e.length>1?await g(n.groupId,f(e[1],n))??"":o,i=(e[0]??"").match(/\{\s*print\s+(.*?)\s*\}/);if(i){const l=i[1],p=t.split(`
`).filter(Boolean).map(d=>{const h=d.split(/\s+/);return l.replace(/\$(\d+)/g,(m,w)=>{const j=parseInt(w,10);return j===0?d:h[j-1]??""})});return r(p.join(`
`)+`
`)}return c("awk: only basic {print $N} patterns supported")}case"ls":{const{flags:t,operands:s}=v(e,[],["l","a","1"]),i=s[0]||".";try{const l=await O(n.groupId,f(i,n));let u=l;return t.a===void 0&&(u=l.filter(p=>!p.startsWith("."))),t[1]!==void 0||t.l!==void 0?r(u.join(`
`)+`
`):r(u.join("  ")+`
`)}catch{return c(`ls: cannot access '${i}': No such directory`)}}case"mkdir":{const{operands:t}=v(e,[],["p"]);for(const s of t)await b(n.groupId,f(s+"/.keep",n),"");return r("")}case"touch":{for(const t of e){const s=f(t,n);await g(n.groupId,s)===null&&await b(n.groupId,s,"")}return r("")}case"cp":{if(e.length<2)return c("cp: missing operands");const t=f(e[0],n),s=f(e[1],n),i=await g(n.groupId,t);return i===null?c(`cp: ${e[0]}: No such file`):(await b(n.groupId,s,i),r(""))}case"mv":{if(e.length<2)return c("mv: missing operands");const t=f(e[0],n),s=f(e[1],n),i=await g(n.groupId,t);return i===null?c(`mv: ${e[0]}: No such file`):(await b(n.groupId,s,i),await R(n.groupId,t),r(""))}case"rm":{const{flags:t,operands:s}=v(e,[],["r","f"]);for(const i of s)try{await R(n.groupId,f(i,n))}catch{if(t.f===void 0)return c(`rm: ${i}: No such file`)}return r("")}case"pwd":return r((n.cwd==="."?"/workspace":`/workspace/${n.cwd}`)+`
`);case"cd":{const t=e[0]??".";return n.cwd=f(t,n),n.env.PWD=`/workspace/${n.cwd}`,r("")}case"date":return r(new Date().toISOString()+`
`);case"env":case"printenv":return r(Object.entries(n.env).map(([t,s])=>`${t}=${s}`).join(`
`)+`
`);case"export":{for(const t of e){const s=t.indexOf("=");s>0&&(n.env[t.slice(0,s)]=t.slice(s+1))}return r("")}case"sleep":{const t=Math.min(parseFloat(e[0]??"0")*1e3,5e3);return await new Promise(s=>setTimeout(s,t)),r("")}case"seq":{const t=e.map(Number);let s=1,i=1,l=1;t.length===1?l=t[0]:t.length===2?(s=t[0],l=t[1]):t.length>=3&&(s=t[0],i=t[1],l=t[2]);const u=[];for(let p=s;i>0?p<=l:p>=l;p+=i)u.push(p);return r(u.join(`
`)+`
`)}case"true":return r("");case"false":return c("",1);case"test":case"[":{const t=a==="["?e.slice(0,-1):e;return H(t,n)}case"base64":{const t=e.length>0&&e[0]!=="-d"?await g(n.groupId,f(e[e.length-1],n))??"":o;return e.includes("-d")||e.includes("--decode")?r(atob(t.trim())):r(btoa(t)+`
`)}case"md5sum":case"sha256sum":{const t=a==="md5sum"?"SHA-1":"SHA-256",s=e.length>0?await g(n.groupId,f(e[0],n))??"":o,i=new TextEncoder().encode(s),l=await crypto.subtle.digest(t,i),u=Array.from(new Uint8Array(l)).map(d=>d.toString(16).padStart(2,"0")).join(""),p=e[0]??"-";return r(`${u}  ${p}
`)}case"tee":{const t=o;for(const s of e)await b(n.groupId,f(s,n),t);return r(t)}case"basename":{const s=(e[0]??"").replace(/\/$/,"").split("/");let i=s[s.length-1]||"";return e[1]&&(i=i.replace(new RegExp(N(e[1])+"$"),"")),r(i+`
`)}case"dirname":{const s=(e[0]??"").split("/");return s.pop(),r((s.join("/")||".")+`
`)}case"xargs":{if(e.length===0)return r(o);const t=o.trim().split(`
`).filter(Boolean),s=e.join(" ")+" "+t.join(" ");return A(s,n)}case"rev":{const t=e.length>0?await g(n.groupId,f(e[0],n))??"":o;return r(t.split(`
`).map(s=>s.split("").reverse().join("")).join(`
`))}case"yes":{const t=e[0]??"y";return r(Array(100).fill(t).join(`
`)+`
`)}case"jq":{const t=e[0]??".",s=e.length>1?await g(n.groupId,f(e[1],n))??"":o;try{let i=JSON.parse(s.trim());if(t!=="."){const l=t.replace(/^\.\s*/,"").split(/\.|\[|\]/).filter(Boolean);for(const u of l){if(u==="keys"){i=Object.keys(i);break}if(u==="length"){i=Array.isArray(i)?i.length:Object.keys(i).length;break}i=i?.[isNaN(Number(u))?u:Number(u)]}}return r(JSON.stringify(i,null,2)+`
`)}catch(i){return c(`jq: ${i instanceof Error?i.message:"parse error"}`)}}case"which":case"command":{const t=e.filter(s=>!s.startsWith("-"))[0]??"";return Q.has(t)?r(`/usr/bin/${t}
`):c(`${a}: ${t}: not found`)}default:return c(`${a}: command not found. Available: echo, cat, head, tail, grep, sort, sed, awk, cut, tr, uniq, wc, ls, mkdir, cp, mv, rm, touch, pwd, cd, date, sleep, seq, base64, jq, tee, xargs, test, rev, basename, dirname. For complex logic, use the "javascript" tool instead.`,127)}}const Q=new Set(["echo","printf","cat","head","tail","wc","grep","sort","uniq","tr","cut","sed","awk","ls","mkdir","cp","mv","rm","touch","pwd","cd","date","env","printenv","export","sleep","seq","true","false","test","base64","md5sum","sha256sum","tee","basename","dirname","xargs","rev","yes","jq","which","command"]);function D(a){if(Date.now()-a.startedAt>a.timeoutMs)throw new Error("[command timed out]")}function f(a,e){let n=a.replace(/^\/workspace\/?/,"");if(!n||n==="/")return".";!n.startsWith("/")&&e.cwd!=="."&&(n=e.cwd+"/"+n),n=n.replace(/^\/+/,"");const o=[];for(const r of n.split("/"))if(!(r==="."||r==="")){if(r===".."){o.pop();continue}o.push(r)}return o.join("/")||"."}function Y(a,e){let n=a.replace(/\$\{(\w+)\}/g,(o,r)=>e[r]??"");return n=n.replace(/\$(\w+)/g,(o,r)=>e[r]??""),n}function ee(a){const e=[];let n="",o=!1,r=!1,c=!1;for(const t of a){if(c){n+=t,c=!1;continue}if(t==="\\"&&!o){c=!0;continue}if(t==="'"&&!r){o=!o;continue}if(t==='"'&&!o){r=!r;continue}if(t===" "&&!o&&!r){n&&e.push(n),n="";continue}n+=t}return n&&e.push(n),e}function v(a,e=[],n=[]){const o={},r=[];let c=0;for(;c<a.length;){const t=a[c];if(t==="--"){r.push(...a.slice(c+1));break}if(t.startsWith("-")&&t.length>1&&!t.startsWith("--")){const s=t.slice(1);if(s.length>1&&!e.includes(s)){for(const i of s)e.includes(i)&&c+1<a.length?o[i]=a[++c]:o[i]="";c++;continue}e.includes(s)&&c+1<a.length?o[s]=a[++c]:o[s]=""}else if(t.startsWith("--")){const s=t.indexOf("=");s>0?o[t.slice(2,s)]=t.slice(s+1):o[t.slice(2)]=""}else r.push(t);c++}return{flags:o,operands:r}}async function g(a,e){try{return await E(a,e)}catch{return null}}function N(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function H(a,e){const n={stdout:"",stderr:"",exitCode:0},o={stdout:"",stderr:"",exitCode:1};if(a.length===0)return o;if(a.length===2)switch(a[0]){case"-f":case"-e":return await G(e.groupId,f(a[1],e))?n:o;case"-d":try{return await O(e.groupId,f(a[1],e)),n}catch{return o}case"-z":return a[1].length===0?n:o;case"-n":return a[1].length>0?n:o}if(a.length===3){const[r,c,t]=a;switch(c){case"=":case"==":return r===t?n:o;case"!=":return r!==t?n:o;case"-eq":return Number(r)===Number(t)?n:o;case"-ne":return Number(r)!==Number(t)?n:o;case"-lt":return Number(r)<Number(t)?n:o;case"-le":return Number(r)<=Number(t)?n:o;case"-gt":return Number(r)>Number(t)?n:o;case"-ge":return Number(r)>=Number(t)?n:o}}return a[0]==="!"?(await H(a.slice(1),e)).exitCode===0?o:n:o}const T="0123456789ABCDEFGHJKMNPQRSTVWXYZ",x=T.length,P=10,te=16;let q=0,$=[];function ne(){const a=Date.now();if(a===q)for(let r=$.length-1;r>=0;r--){if($[r]<x-1){$[r]++;break}$[r]=0}else q=a,$=Array.from(crypto.getRandomValues(new Uint8Array(te)),r=>r%x);let e=a;const n=new Array(P);for(let r=P-1;r>=0;r--)n[r]=T[e%x],e=Math.floor(e/x);const o=$.map(r=>T[r]);return n.join("")+o.join("")}self.onmessage=async a=>{const{type:e,payload:n}=a.data;switch(e){case"invoke":await oe(n);break;case"compact":await re(n);break}};async function oe(a){const{groupId:e,messages:n,systemPrompt:o,apiKey:r,model:c,maxTokens:t}=a;y({type:"typing",payload:{groupId:e}}),k(e,"info","Starting",`Model: ${c} · Max tokens: ${t}`);try{let s=[...n],i=0;const l=25;for(;i<l;){i++;const u={model:c,max_tokens:t,system:o,messages:s,tools:J};k(e,"api-call",`API call #${i}`,`${s.length} messages in context`);const p=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r,"anthropic-version":F,"anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(u)});if(!p.ok){const h=await p.text();throw new Error(`Anthropic API error ${p.status}: ${h}`)}const d=await p.json();d.usage&&y({type:"token-usage",payload:{groupId:e,inputTokens:d.usage.input_tokens||0,outputTokens:d.usage.output_tokens||0,contextLimit:ie(c)}});for(const h of d.content)if(h.type==="text"&&h.text){const m=h.text.length>200?h.text.slice(0,200)+"…":h.text;k(e,"text","Response text",m)}if(d.stop_reason==="tool_use"){const h=[];for(const m of d.content)if(m.type==="tool_use"){const w=JSON.stringify(m.input),j=w.length>300?w.slice(0,300)+"…":w;k(e,"tool-call",`Tool: ${m.name}`,j),y({type:"tool-activity",payload:{groupId:e,tool:m.name,status:"running"}});const S=await se(m.name,m.input,e),_=typeof S=="string"?S:JSON.stringify(S),U=_.length>500?_.slice(0,500)+"…":_;k(e,"tool-result",`Result: ${m.name}`,U),y({type:"tool-activity",payload:{groupId:e,tool:m.name,status:"done"}}),h.push({type:"tool_result",tool_use_id:m.id,content:typeof S=="string"?S.slice(0,1e5):JSON.stringify(S).slice(0,1e5)})}s.push({role:"assistant",content:d.content}),s.push({role:"user",content:h}),y({type:"typing",payload:{groupId:e}})}else{const m=d.content.filter(w=>w.type==="text").map(w=>w.text).join("").replace(/<internal>[\s\S]*?<\/internal>/g,"").trim();y({type:"response",payload:{groupId:e,text:m||"(no response)"}});return}}y({type:"response",payload:{groupId:e,text:"⚠️ Reached maximum tool-use iterations (25). Stopping to avoid excessive API usage."}})}catch(s){const i=s instanceof Error?s.message:String(s);y({type:"error",payload:{groupId:e,error:i}})}}async function re(a){const{groupId:e,messages:n,systemPrompt:o,apiKey:r,model:c,maxTokens:t}=a;y({type:"typing",payload:{groupId:e}}),k(e,"info","Compacting context",`Summarizing ${n.length} messages`);try{const s=[o,"","## COMPACTION TASK","","The conversation context is getting large. Produce a concise summary of the conversation so far.","Include key facts, decisions, user preferences, and any important context.","The summary will replace the full conversation history to stay within token limits.","Be thorough but concise — aim for the essential information only."].join(`
`),i=[...n,{role:"user",content:"Please provide a concise summary of our entire conversation so far. Include all key facts, decisions, code discussed, and important context. This summary will replace the full history."}],l={model:c,max_tokens:Math.min(t,4096),system:s,messages:i},u=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r,"anthropic-version":F,"anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(l)});if(!u.ok){const h=await u.text();throw new Error(`Anthropic API error ${u.status}: ${h}`)}const d=(await u.json()).content.filter(h=>h.type==="text").map(h=>h.text).join("");k(e,"info","Compaction complete",`Summary: ${d.length} chars`),y({type:"compact-done",payload:{groupId:e,summary:d}})}catch(s){const i=s instanceof Error?s.message:String(s);y({type:"error",payload:{groupId:e,error:`Compaction failed: ${i}`}})}}async function se(a,e,n){try{switch(a){case"bash":{const o=await z(e.command,n,{},Math.min(e.timeout||30,120));let r=o.stdout;return o.stderr&&(r+=(r?`
`:"")+o.stderr),o.exitCode!==0&&!o.stderr&&(r+=`
[exit code: ${o.exitCode}]`),r||"(no output)"}case"read_file":return await E(n,e.path);case"write_file":return await b(n,e.path,e.content),`Written ${e.content.length} bytes to ${e.path}`;case"list_files":{const o=await O(n,e.path||".");return o.length>0?o.join(`
`):"(empty directory)"}case"fetch_url":{const o=await fetch(e.url,{method:e.method||"GET",headers:e.headers,body:e.body}),r=await o.text();return`[HTTP ${o.status}]
`+r.slice(0,L)}case"update_memory":return await b(n,"CLAUDE.md",e.content),"Memory updated successfully.";case"create_task":{const o={id:ne(),groupId:n,schedule:e.schedule,prompt:e.prompt,enabled:!0,lastRun:null,createdAt:Date.now()};return`__TASK_CREATED__${JSON.stringify(o)}`}case"javascript":try{const o=e.code,r=(0,eval)(`"use strict";
${o}`);if(r===void 0)return"(no return value)";if(r===null)return"null";if(typeof r=="object")try{return JSON.stringify(r,null,2)}catch{}return String(r)}catch(o){return`JavaScript error: ${o instanceof Error?o.message:String(o)}`}default:return`Unknown tool: ${a}`}}catch(o){return`Tool error (${a}): ${o instanceof Error?o.message:String(o)}`}}function y(a){self.postMessage(a)}function ie(a){return 3e4}function k(a,e,n,o){y({type:"thinking-log",payload:{groupId:a,kind:e,timestamp:Date.now(),label:n,detail:o}})}
